@startuml EvaluationFlow
title GraphJudge Evaluation Flow

skinparam participant {
    BackgroundColor<<Purple>> #E8D5F2
    BackgroundColor<<Green>> #C8E6C9
    BackgroundColor<<Eval>> #B3E5FC
}

actor "Benchmark\nCreator" as User
participant "Green Agent\n(Assessor)" as Green <<Green>>
participant "Messenger" as Msg <<Green>>
participant "Purple Agent\n(Under Test)" as Purple <<Purple>>
participant "Tier 1: Graph\nEvaluator" as Graph <<Eval>>
participant "Tier 2: LLM\nJudge" as LLM <<Eval>>
participant "Tier 2: Latency\nEvaluator" as Latency <<Eval>>
participant "Tier 3: Text\n(plugin)" as Text <<Eval>>

== Task Submission ==
User -> Green: POST /tasks/send\n(A2A JSON-RPC)
activate Green

== Trace Capture ==
Green -> Msg: talk_to_agent(urls, task)
activate Msg

loop For each Purple Agent URL
    Msg -> Purple: A2A send_message()\n+ X-A2A-Extensions header
    activate Purple
    Purple --> Msg: TaskState events\n(pending → running → completed)
    deactivate Purple
    Msg -> Msg: Capture InteractionStep\n(trace_id, latency, timestamps)
end

Msg --> Green: TraceData[]\n(all interactions)
deactivate Msg

== Multi-Tier Evaluation ==
Green -> Graph: evaluate(TraceData)
activate Graph
note right of Graph
  - Build DiGraph (nodes=agents, edges=interactions)
  - Compute centrality (degree, betweenness, closeness)
  - Detect bottlenecks, isolation
  - Calculate density, clustering
end note
Graph --> Green: GraphMetrics
deactivate Graph

Green -> LLM: evaluate(TraceData)
activate LLM
note right of LLM
  - Serialize traces to prompt
  - Call OpenAI-compatible API
  - Parse JSON response
  - Fallback to rule-based if unavailable
end note
LLM --> Green: LLMJudgment\n(score, reasoning, strengths, weaknesses)
deactivate LLM

Green -> Latency: evaluate(TraceData)
activate Latency
note right of Latency
  - Extract step.latency values
  - Compute percentiles (avg, p50, p95, p99)
  - Identify slowest agent
end note
Latency --> Green: LatencyMetrics
deactivate Latency

Green -> Text: evaluate(TraceData)
activate Text
note right of Text
  - Plugin example (extensibility)
  - Basic text similarity
  - Demonstrates evaluator pattern
end note
Text --> Green: TextMetrics
deactivate Text

== Response ==
Green --> User: A2A TaskResult\n{tier1_graph, tier2_llm, tier2_latency, tier3_text}
deactivate Green

@enduml
